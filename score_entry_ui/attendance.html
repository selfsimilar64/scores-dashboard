<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - Gymfest</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f12;
            --bg-card: #1a1a22;
            --bg-elevated: #252532;
            --accent-primary: #e85d75;
            --accent-secondary: #64d2ff;
            --accent-success: #30d158;
            --accent-warning: #ffd60a;
            --accent-gold: #ffd700;
            --accent-orange: #ff9f0a;
            --accent-red: #ff453a;
            --accent-purple: #bf5af2;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --text-muted: #636366;
            --border-color: #2c2c3a;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            
            /* Attendance status colors - adjusted */
            --status-present: #30d158;
            --status-present-text: #0a2910;
            --status-late: #eaef57;  /* Yellow-green, close to present */
            --status-late-text: #0a2910;
            --status-absent: #e25a55;
            --status-absent-text: #0a2910;
            --status-partial: #ffa927;  /* Yellow/orange */
            --status-partial-text: #0a2910;
            --status-none: #2a2a3a;
            --status-none-text: #757576;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Minimal nav */
        .nav-bar {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            padding: 8px 0;
            margin-bottom: 12px;
        }

        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.15s ease;
        }

        .nav-link:hover {
            color: var(--text-secondary);
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }

        .view-tab {
            padding: 10px 24px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .view-tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .view-tab.active {
            background: var(--accent-success);
            color: var(--bg-dark);
            font-weight: 600;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        /* Level Tabs */
        .level-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .level-tab {
            padding: 8px 18px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .level-tab:hover {
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        .level-tab.active {
            background: var(--accent-success);
            color: var(--bg-dark);
            font-weight: 600;
        }

        /* Athlete Cards Grid - Today View - 50% larger */
        .athlete-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            grid-auto-rows: 1fr;
        }

        .athlete-card {
            border-radius: 14px;
            padding: 24px 18px;
            cursor: pointer;
            transition: all 0.12s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }

        .athlete-card:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .athlete-card:active {
            transform: scale(0.98);
        }

        /* Card status colors */
        .athlete-card.status-none { background: var(--status-none); }
        .athlete-card.status-none .athlete-card-name { color: var(--status-none-text); }

        .athlete-card.status-present { background: var(--status-present); }
        .athlete-card.status-present .athlete-card-name { color: var(--status-present-text); }

        .athlete-card.status-absent { background: var(--status-absent); }
        .athlete-card.status-absent .athlete-card-name { color: var(--status-absent-text); }

        .athlete-card.status-partial { background: var(--status-partial); }
        .athlete-card.status-partial .athlete-card-name { color: var(--status-partial-text); }

        .athlete-card-name {
            font-weight: 600;
            font-size: 1.1rem;
            text-align: center;
            line-height: 1.3;
            transition: color 0.12s ease;
        }

        /* Minimal note button */
        .note-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(0, 0, 0, 0.12);
            color: inherit;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.12s ease;
            opacity: 0.5;
        }

        .note-btn:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.2);
        }

        .note-btn.has-note {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .note-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Session View Controls */
        .session-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .session-controls label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        select {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-family: inherit;
            color: var(--text-primary);
            cursor: pointer;
            min-width: 140px;
            transition: border-color 0.15s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-success);
        }

        /* Layout toggle */
        .layout-toggle {
            display: flex;
            gap: 4px;
        }

        .layout-btn {
            padding: 6px 12px;
            border: none;
            background: var(--bg-dark);
            color: var(--text-muted);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .layout-btn:hover {
            color: var(--text-secondary);
        }

        .layout-btn.active {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* Base Attendance Table */
        .attendance-grid-container {
            overflow: auto;
            max-height: calc(100vh - 280px);
        }

        .attendance-table {
            border-collapse: collapse;
            width: 100%;
        }

        /* COMPACT LAYOUT - pixel-tight grid */
        .attendance-grid-container.layout-compact {
            background: #111114;
            border-radius: 0;
        }

        .layout-compact .attendance-table {
            border-spacing: 1px;
            border-collapse: separate;
            background: #111114;
        }

        .layout-compact .attendance-table th,
        .layout-compact .attendance-table td {
            padding: 0;
            border: none;
            background: #111114;
            text-align: center;
            vertical-align: middle;
        }

        .layout-compact .attendance-table th {
            height: 60px;
            vertical-align: bottom;
            padding-bottom: 6px;
        }

        /* Force attendance td to be exactly the cell size */
        .layout-compact .attendance-table td:not(.name-col):not(.pct-col) {
            width: 19px;
            min-width: 19px;
            max-width: 19px;
            height: 19px;
            padding: 0;
        }

        .layout-compact .attendance-table th:not(.name-col):not(.pct-col) {
            width: 19px;
            min-width: 19px;
            max-width: 19px;
        }

        .layout-compact .attendance-table td.name-col {
            padding: 0 4px 0 2px;
            font-size: 0.72rem;
            font-weight: 500;
            width: auto;
            min-width: 95px;
            max-width: 115px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: sticky;
            left: 0;
            z-index: 5;
            text-align: left;
            height: 19px;
        }

        .layout-compact .attendance-table th.name-col {
            text-align: left;
            padding-left: 2px;
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            position: sticky;
            left: 0;
            z-index: 10;
            width: auto;
        }

        .layout-compact .date-header {
            transform: rotate(-55deg);
            transform-origin: center center;
            font-size: 0.55rem;
            line-height: 1;
            white-space: nowrap;
            color: var(--text-muted);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 2px;
        }

        .layout-compact .date-header .day {
            font-weight: 600;
        }

        .layout-compact .date-header .date {
            color: #ffffff;
        }
        
        /* Day of week colors */
        .date-header .day.dow-sun { color: #ff7eb3; }
        .date-header .day.dow-mon { color: #7eb3ff; }
        .date-header .day.dow-tue { color: #7eff9e; }
        .date-header .day.dow-wed { color: #ffcf7e; }
        .date-header .day.dow-thu { color: #c87eff; }
        .date-header .day.dow-fri { color: #7ef0ff; }
        .date-header .day.dow-sat { color: #ffff7e; }

        .layout-compact .attendance-cell {
            width: 18px;
            height: 18px;
            border-radius: 2px;
            display: block;
            margin: 0 auto;
            transform: none !important;
        }

        .layout-compact .attendance-cell.animating {
            animation: statusFlash 0.15s ease-out !important;
        }

        .layout-compact .attendance-table th.pct-col,
        .layout-compact .attendance-table td.pct-col {
            padding: 0 2px;
            font-size: 0.55rem;
            min-width: 32px;
            width: auto;
            height: auto;
        }

        .layout-compact .attendance-table th.pct-col {
            vertical-align: bottom;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* NORMAL LAYOUT */
        .attendance-grid-container.layout-normal {
            border-radius: 12px;
            background: var(--bg-elevated);
        }

        .layout-normal .attendance-table th,
        .layout-normal .attendance-table td {
            padding: 8px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .layout-normal .attendance-table th {
            background: var(--bg-card);
            font-weight: 500;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .layout-normal .attendance-table th:first-child {
            border-radius: 12px 0 0 0;
        }

        .layout-normal .attendance-table th:last-child {
            border-radius: 0 12px 0 0;
        }

        .layout-normal .attendance-table th.name-col,
        .layout-normal .attendance-table td.name-col {
            position: sticky;
            left: 0;
            z-index: 15;
            background: var(--bg-elevated);
            min-width: 140px;
            max-width: 160px;
            width: 160px;
            text-align: left;
            padding-left: 12px;
            padding-right: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .layout-normal .attendance-table th.name-col {
            z-index: 20;
            background: var(--bg-card);
        }

        .layout-normal .attendance-table td.name-col {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .layout-normal .attendance-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.015);
        }

        .layout-normal .attendance-table tbody tr:last-child td:first-child {
            border-radius: 0 0 0 12px;
        }

        .layout-normal .attendance-table tbody tr:last-child td:last-child {
            border-radius: 0 0 12px 0;
        }

        .layout-normal .attendance-table th.pct-col {
            min-width: 50px;
            background: var(--bg-dark);
        }

        .layout-normal .attendance-table td.pct-col {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .layout-normal .date-header {
            font-size: 0.6rem;
            line-height: 1.3;
        }

        .layout-normal .date-header .day {
            display: block;
            font-weight: 600;
        }

        .layout-normal .date-header .date {
            display: block;
            color: #ffffff;
        }

        .layout-normal .attendance-cell {
            width: 28px;
            height: 28px;
            border-radius: 5px;
            display: inline-block;
            margin: 0;
        }

        /* Attendance cells - shared styles */
        .attendance-cell {
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .attendance-cell:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .attendance-cell:active {
            transform: scale(0.95);
        }

        .attendance-cell.status-present { background: var(--status-present); }
        .attendance-cell.status-absent { background: var(--status-absent); }
        .attendance-cell.status-partial { background: var(--status-partial); }
        .attendance-cell.status-none { background: var(--status-none); }

        /* Animation for status change */
        @keyframes statusPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1); }
            100% { transform: scale(1); }
        }

        @keyframes statusFlash {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .athlete-card.animating {
            animation: statusPulse 0.2s ease;
        }

        .attendance-cell.animating {
            animation: statusFlash 0.15s ease-out;
        }

        /* Percentage colors */
        .pct-high { color: var(--status-present); }
        .pct-medium { color: var(--status-partial); }
        .pct-low { color: var(--status-absent); }

        /* Compact Status Legend */
        .status-legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .status-legend.vertical {
            position: absolute;
            right: 16px;
            top: 16px;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Day navigation */
        .day-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .day-nav-btn {
            background: #1e1e24;
            border: 1px solid #3a3a44;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0a0a8;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: 400;
            transition: all 0.12s ease;
            flex-shrink: 0;
        }

        .day-nav-btn:hover:not(:disabled) {
            background: #2a2a34;
            color: #ffffff;
            border-color: #5a5a66;
        }

        .day-nav-btn:active:not(:disabled) {
            transform: scale(0.95);
            background: #252530;
        }

        .day-nav-btn:disabled {
            opacity: 0.25;
            cursor: not-allowed;
        }

        .day-nav-date {
            text-align: center;
            width: 240px;
            flex-shrink: 0;
        }

        .day-nav-date .date-main {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: opacity 0.1s ease;
        }

        .day-nav-date .date-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
            transition: opacity 0.1s ease;
        }

        .day-nav-date.fade-out .date-main,
        .day-nav-date.fade-out .date-sub {
            opacity: 0;
        }

        .day-view-card {
            position: relative;
        }

        /* Shimmer loading effect */
        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .shimmer {
            position: relative;
            overflow: hidden;
        }

        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 25%,
                rgba(255, 255, 255, 0.08) 50%,
                transparent 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        .skeleton-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            grid-auto-rows: 1fr;
        }

        .skeleton-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            min-height: 100px;
            padding: 24px 18px;
        }

        .skeleton-tabs {
            display: flex;
            gap: 6px;
        }

        .skeleton-tab {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            width: 50px;
            height: 34px;
            border-radius: 8px;
        }

        .skeleton-table {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
        }

        .skeleton-row {
            background: var(--bg-card);
            height: 36px;
        }

        .skeleton-header {
            background: var(--bg-card);
            height: 50px;
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Setup Panel */
        .setup-panel {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
        }

        .setup-section {
            margin-bottom: 20px;
        }

        .setup-section:last-child {
            margin-bottom: 0;
        }

        .setup-section h3 {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .form-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"] {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-family: inherit;
            color: var(--text-primary);
            transition: border-color 0.15s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-success);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent-success);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--text-muted);
        }

        .schedule-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .schedule-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 16px;
            font-size: 0.8rem;
        }

        .schedule-chip .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            line-height: 1;
            transition: color 0.12s ease;
        }

        .schedule-chip .remove-btn:hover {
            color: var(--accent-red);
        }

        /* Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .schedule-table th {
            text-align: left;
            padding: 8px 12px;
            color: var(--text-muted);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .schedule-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
        }

        .schedule-table tr:hover {
            background: var(--bg-hover);
        }

        .schedule-table .actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .schedule-table .action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            transition: all 0.12s ease;
        }

        .schedule-table .action-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .schedule-table .action-btn.delete:hover {
            color: var(--accent-red);
        }

        .schedule-table input,
        .schedule-table select {
            padding: 4px 8px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        .schedule-table input:focus,
        .schedule-table select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .schedule-table input[type="time"] {
            width: 100px;
        }

        .schedule-table select {
            min-width: 70px;
        }

        .session-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .session-group-header h4 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .copy-section {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .copy-section .form-group {
            margin: 0;
        }

        .copy-section label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .copy-section select {
            min-width: 140px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 380px;
            border: 1px solid var(--border-color);
        }

        .modal h3 {
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .modal-section {
            margin-bottom: 16px;
        }

        .modal-section-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .modal textarea {
            width: 100%;
            min-height: 80px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text-primary);
            resize: vertical;
            transition: border-color 0.15s ease;
        }

        .modal textarea:focus {
            outline: none;
            border-color: var(--accent-success);
        }

        /* Late time picker */
        .late-time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .late-time-btn {
            padding: 8px 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.12s ease;
        }

        .late-time-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .late-time-btn.active {
            background: var(--accent-warning);
            border-color: var(--accent-warning);
            color: var(--bg-dark);
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 16px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--accent-red);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 2000;
            opacity: 0;
            transition: all 0.25s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .toast.success {
            background: var(--accent-success);
            color: var(--bg-dark);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* iPad optimization */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 20px;
            }
            
            .athlete-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        /* ============================================================
           ACCESSIBILITY: Reduced Motion
           ============================================================ */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .shimmer {
                animation: none;
                background: #1a1a20;
            }
            
            .day-nav-date .date-main,
            .day-nav-date .date-sub {
                transition: none;
            }
        }

        /* ============================================================
           RESPONSIVE: Desktop Large (1440px+)
           ============================================================ */
        @media (min-width: 1440px) {
            .container {
                max-width: 1400px;
                padding: clamp(16px, 2vw, 32px);
            }
            
            .athlete-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }

        /* ============================================================
           RESPONSIVE: Desktop (1025px - 1439px)
           ============================================================ */
        @media (min-width: 1025px) and (max-width: 1439px) {
            .container {
                padding: clamp(16px, 2vw, 24px);
            }
        }

        /* ============================================================
           RESPONSIVE: Tablet Landscape / iPad Pro (1024px)
           ============================================================ */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .container {
                max-width: 100%;
                padding: 16px 24px;
            }
            
            .session-controls {
                flex-wrap: nowrap;
            }
            
            .athlete-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 12px;
            }
            
            .layout-normal .attendance-table td.name-col {
                min-width: 120px;
                max-width: 140px;
            }
        }

        /* ============================================================
           RESPONSIVE: Tablet Portrait / iPad (768px - 1024px)
           ============================================================ */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .container {
                padding: 16px;
            }
            
            .athlete-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .session-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .session-controls .status-legend {
                margin-left: 0;
                margin-top: 8px;
            }
            
            .status-legend.vertical {
                position: static;
                flex-direction: row;
                flex-wrap: wrap;
                margin-bottom: 12px;
            }
            
            .day-nav-date {
                width: 200px;
            }
        }

        /* ============================================================
           RESPONSIVE: Mobile (< 768px)
           ============================================================ */
        @media (max-width: 767px) {
            .container {
                padding: clamp(8px, 3vw, 16px);
            }

            .athlete-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 8px;
            }

            .athlete-card {
                padding: 14px 12px;
                min-height: 75px;
            }

            .athlete-card-name {
                font-size: clamp(0.85rem, 3.5vw, 1rem);
            }

            .view-tabs {
                gap: 4px;
            }

            .view-tab {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .level-tab {
                padding: 6px 12px;
                font-size: 0.75rem;
            }
            
            /* Day navigation compact on mobile */
            .day-nav {
                gap: 8px;
            }
            
            .day-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .day-nav-date {
                width: 180px;
            }
            
            .day-nav-date .date-main {
                font-size: 1rem;
            }
            
            /* Legend below navigation on mobile */
            .status-legend.vertical {
                position: static;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 12px;
                gap: 12px;
            }
            
            /* Session controls stack on mobile */
            .session-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .session-controls .status-legend {
                margin-left: 0;
                justify-content: flex-start;
            }
            
            .layout-toggle {
                align-self: flex-start;
            }
            
            /* Compact table even more on mobile */
            .layout-compact .attendance-table td.name-col {
                min-width: 70px;
                max-width: 90px;
                font-size: 0.65rem;
            }
            
            .layout-compact .attendance-table th,
            .layout-compact .attendance-table td {
                font-size: 0.5rem;
            }
            
            .layout-compact .attendance-cell {
                width: 14px;
                height: 14px;
            }
            
            /* Normal layout adjustments for mobile */
            .layout-normal .attendance-table td.name-col {
                min-width: 100px;
                max-width: 120px;
                font-size: 0.75rem;
            }
            
            .layout-normal .attendance-cell {
                width: 22px;
                height: 22px;
            }
            
            /* Setup sections full width */
            .setup-section {
                padding: 12px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                width: 100%;
            }
            
            .copy-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .copy-section select {
                min-width: 100%;
            }
        }

        /* ============================================================
           RESPONSIVE: Small Mobile (< 480px)
           ============================================================ */
        @media (max-width: 479px) {
            .athlete-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .athlete-card {
                padding: 12px 10px;
                min-height: 65px;
            }
            
            .athlete-card-name {
                font-size: 0.85rem;
            }
            
            .note-btn {
                width: 20px;
                height: 20px;
            }
            
            .day-nav-date {
                width: 150px;
            }
            
            .day-nav-date .date-main {
                font-size: 0.9rem;
            }
            
            /* Hide DOW percentages on very small screens */
            .layout-compact .attendance-table th.pct-col:not(:first-of-type),
            .layout-compact .attendance-table td.pct-col:not(:first-of-type) {
                display: none;
            }
        }

        /* ============================================================
           FLUID TYPOGRAPHY
           ============================================================ */
        .card h3 {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
        }
        
        .setup-section h3 {
            font-size: clamp(0.8rem, 1.8vw, 0.9rem);
        }
        
        .empty-state h3 {
            font-size: clamp(1rem, 3vw, 1.25rem);
        }
        
        .empty-state p {
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Minimal nav -->
        <nav class="nav-bar">
            <a href="/" class="nav-link">Scores</a>
            <a href="/meet-scores" class="nav-link">Meet Scores</a>
            <a href="/meet-averages" class="nav-link">Averages</a>
        </nav>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" data-view="today">Day</button>
            <button class="view-tab" data-view="session">Session</button>
            <button class="view-tab" data-view="setup">Setup</button>
        </div>

        <!-- Day View -->
        <div id="todayView" class="view-content">
            <div class="card day-view-card">
                <div class="status-legend vertical">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--status-none)"></div>
                        <span>None</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--status-present)"></div>
                        <span>Present</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--status-absent)"></div>
                        <span>Absent</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--status-partial)"></div>
                        <span>Partial</span>
                    </div>
                </div>

                <div class="day-nav">
                    <button class="day-nav-btn" onclick="navigateDay(-1)" id="dayPrevBtn">&lt;</button>
                    <div class="day-nav-date" id="dayNavDate">
                        <div class="date-main" id="dayNavDateMain">Loading...</div>
                        <div class="date-sub" id="dayNavDateSub"></div>
                    </div>
                    <button class="day-nav-btn" onclick="navigateDay(1)" id="dayNextBtn">&gt;</button>
                </div>

                <div class="level-tabs" id="levelTabs"></div>
                <div id="todayContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Session View -->
        <div id="sessionView" class="view-content" style="display: none;">
            <div class="card" style="position: relative;">
                <div class="session-controls">
                    <label for="sessionSelect">Session:</label>
                    <select id="sessionSelect">
                        <option value="">Select session...</option>
                    </select>
                    
                    <div class="layout-toggle">
                        <button class="layout-btn active" data-layout="compact" onclick="setLayout('compact')">Compact</button>
                        <button class="layout-btn" data-layout="normal" onclick="setLayout('normal')">Normal</button>
                    </div>
                    
                    <div class="status-legend" style="margin-left: auto;">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--status-none)"></div>
                            <span>None</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--status-present)"></div>
                            <span>Present</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--status-absent)"></div>
                            <span>Absent</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: var(--status-partial)"></div>
                            <span>Partial</span>
                        </div>
                    </div>
                </div>

                <div class="level-tabs" id="sessionLevelTabs"></div>

                <div id="sessionContent">
                    <div class="empty-state">
                        <h3>Select a Session</h3>
                        <p>Choose a session to view attendance</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Setup View -->
        <div id="setupView" class="view-content" style="display: none;">
            <div class="card">
                <div class="setup-panel">
                    <div class="setup-section">
                        <h3>Create Session</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" id="sessionName" placeholder="Winter 2026">
                            </div>
                            <div class="form-group">
                                <label>Year</label>
                                <input type="number" id="sessionYear" value="2026">
                            </div>
                            <div class="form-group">
                                <label>Season</label>
                                <select id="sessionSeason">
                                    <option value="winter">Winter</option>
                                    <option value="spring">Spring</option>
                                    <option value="summer">Summer</option>
                                    <option value="fall">Fall</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Start</label>
                                <input type="date" id="sessionStartDate">
                            </div>
                            <div class="form-group">
                                <label>End</label>
                                <input type="date" id="sessionEndDate">
                            </div>
                            <div class="form-group" style="justify-content: flex-end;">
                                <button class="btn btn-primary" onclick="createSession()">Create</button>
                            </div>
                        </div>
                    </div>

                    <div class="setup-section">
                        <h3>Sessions</h3>
                        <div id="existingSessions"><div class="loading">Loading...</div></div>
                    </div>

                    <div class="setup-section">
                        <h3>Practice Schedules</h3>
                        
                        <div class="copy-section">
                            <div class="form-group">
                                <label>Copy from</label>
                                <select id="copySourceSession"><option value="">Select source...</option></select>
                            </div>
                            <div class="form-group">
                                <label>Copy to</label>
                                <select id="copyTargetSession"><option value="">Select target...</option></select>
                            </div>
                            <button class="btn btn-secondary" onclick="copySchedules()">Copy All Schedules</button>
                        </div>
                        
                        <div id="currentSchedules"><div class="loading">Loading...</div></div>
                    </div>

                    <div class="setup-section">
                        <h3>Special Practice Dates</h3>
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">
                            Add one-off practice dates that don't follow the regular schedule (e.g., holiday practices, makeup days)
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Session</label>
                                <select id="specialSession"><option value="">Select...</option></select>
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="specialDate">
                            </div>
                            <div class="form-group">
                                <label>Level</label>
                                <select id="specialLevel"><option value="">Select...</option></select>
                            </div>
                            <div class="form-group">
                                <label>Start</label>
                                <input type="time" id="specialStartTime" value="17:00">
                            </div>
                            <div class="form-group">
                                <label>End</label>
                                <input type="time" id="specialEndTime" value="19:00">
                            </div>
                            <div class="form-group" style="justify-content: flex-end;">
                                <button class="btn btn-primary" onclick="addSpecialDate()">Add</button>
                            </div>
                        </div>
                        <div id="specialDatesContainer" style="margin-top: 12px;"></div>
                    </div>

                    <div class="setup-section">
                        <h3>Add Athlete</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" id="newAthleteName" placeholder="Athlete name">
                            </div>
                            <div class="form-group">
                                <label>Level</label>
                                <select id="newAthleteLevel"><option value="">Select...</option></select>
                            </div>
                            <div class="form-group" style="justify-content: flex-end;">
                                <button class="btn btn-primary" onclick="addAthlete()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <h3>Note for <span id="noteAthleteName"></span></h3>
            
            <div class="modal-section">
                <span class="modal-section-label">Late by:</span>
                <div class="late-time-grid">
                    <button class="late-time-btn" data-minutes="0" onclick="selectLateTime(0)">On time</button>
                    <button class="late-time-btn" data-minutes="5" onclick="selectLateTime(5)">5 min</button>
                    <button class="late-time-btn" data-minutes="10" onclick="selectLateTime(10)">10 min</button>
                    <button class="late-time-btn" data-minutes="15" onclick="selectLateTime(15)">15 min</button>
                    <button class="late-time-btn" data-minutes="20" onclick="selectLateTime(20)">20 min</button>
                    <button class="late-time-btn" data-minutes="30" onclick="selectLateTime(30)">30 min</button>
                </div>
            </div>
            
            <div class="modal-section">
                <span class="modal-section-label">Note:</span>
                <textarea id="noteText" placeholder="Injury, absence reason, etc."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNote()">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let currentSession = null;
        let todayData = null;
        let currentLevel = null;
        let sessionData = null;
        let sessionCurrentLevel = null;
        let sessionLayout = 'compact';
        let noteAthleteId = null;
        let noteLevel = null;
        let notePracticeDate = null;
        let selectedLateTime = 0;
        
        // Day view navigation state
        let currentDayDate = new Date().toISOString().split('T')[0];
        let practiceDates = [];
        let currentDayIndex = -1;
        let dayNavDebounceTimer = null;
        const DAY_NAV_DEBOUNCE_MS = 600;

        // Pending changes for debouncing
        const pendingChanges = new Map();
        const DEBOUNCE_DELAY = 400;

        const STATUS_CYCLE = ['none', 'present', 'absent', 'partial'];
        const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const FULL_DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        // Level sort order: numeric levels 1-10, then Xcel levels
        const XCEL_ORDER = ['XB', 'XS', 'XG', 'XP', 'XD', 'XSA'];
        
        function sortLevels(levels) {
            return [...levels].sort((a, b) => {
                // Extract level string (handle both object and string)
                const levelA = typeof a === 'object' ? a.level : a;
                const levelB = typeof b === 'object' ? b.level : b;
                
                const numA = parseInt(levelA);
                const numB = parseInt(levelB);
                const isNumA = !isNaN(numA);
                const isNumB = !isNaN(numB);
                
                // Both numeric: sort by number
                if (isNumA && isNumB) {
                    return numA - numB;
                }
                
                // Numeric comes before Xcel
                if (isNumA && !isNumB) return -1;
                if (!isNumA && isNumB) return 1;
                
                // Both Xcel: sort by predefined order
                const idxA = XCEL_ORDER.indexOf(levelA);
                const idxB = XCEL_ORDER.indexOf(levelB);
                
                // Known Xcel levels sort by order, unknown go to end
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                
                // Fallback: alphabetical
                return levelA.localeCompare(levelB);
            });
        }

        // Toast notification
        function showToast(message, type = 'error', duration = 2500) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // Debounced save function
        function debouncedSave(key, data) {
            if (pendingChanges.has(key)) {
                clearTimeout(pendingChanges.get(key).timeoutId);
            }

            const timeoutId = setTimeout(() => {
                actualSave(key, data);
            }, DEBOUNCE_DELAY);

            pendingChanges.set(key, { ...data, timeoutId });
        }

        async function actualSave(key, data) {
            pendingChanges.delete(key);

            try {
                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving attendance:', error);
                showToast('Failed to save: ' + error.message);
            }
        }

        // Layout toggle
        function setLayout(layout) {
            sessionLayout = layout;
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.layout === layout);
            });
            renderSessionGrid();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });

            loadTodaysPractice();
            loadSessions();
            loadLevels();
        });

        function switchView(view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-tab[data-view="${view}"]`).classList.add('active');

            document.querySelectorAll('.view-content').forEach(v => v.style.display = 'none');
            document.getElementById(`${view}View`).style.display = 'block';

            if (view === 'session') {
                loadSessionAttendance();
            } else if (view === 'setup') {
                loadSetupData();
            }
        }

        // =====================
        // DAY PRACTICE VIEW
        // =====================
        
        // Shimmer loading skeleton generators
        function showDayShimmer() {
            // Put skeleton tabs directly (level-tabs class provides flex and margin)
            document.getElementById('levelTabs').innerHTML = `
                <div class="skeleton-tab shimmer"></div>
                <div class="skeleton-tab shimmer"></div>
                <div class="skeleton-tab shimmer"></div>
            `;
            document.getElementById('todayContent').innerHTML = `
                <div class="skeleton-grid">
                    ${Array(8).fill('<div class="skeleton-card shimmer"></div>').join('')}
                </div>
            `;
        }

        function showSessionShimmer() {
            // Put skeleton tabs directly (level-tabs class provides flex and margin)
            document.getElementById('sessionLevelTabs').innerHTML = `
                <div class="skeleton-tab shimmer"></div>
                <div class="skeleton-tab shimmer"></div>
                <div class="skeleton-tab shimmer"></div>
            `;
            document.getElementById('sessionContent').innerHTML = `
                <div class="skeleton-table">
                    <div class="skeleton-header shimmer"></div>
                    ${Array(10).fill('<div class="skeleton-row shimmer"></div>').join('')}
                </div>
            `;
        }
        
        async function loadTodaysPractice() {
            showDayShimmer();
            
            // First, load practice dates for navigation
            try {
                const datesResponse = await fetch('/api/practice_dates');
                const datesData = await datesResponse.json();
                practiceDates = datesData.dates || [];
                
                // Find today's date or closest future date in practice dates
                const today = new Date().toISOString().split('T')[0];
                currentDayIndex = practiceDates.indexOf(today);
                
                if (currentDayIndex === -1) {
                    // Find the closest practice date to today
                    currentDayIndex = practiceDates.findIndex(d => d >= today);
                    if (currentDayIndex === -1 && practiceDates.length > 0) {
                        currentDayIndex = practiceDates.length - 1; // Use last date if all are in past
                    }
                }
                
                if (practiceDates.length > 0 && currentDayIndex >= 0) {
                    currentDayDate = practiceDates[currentDayIndex];
                }
            } catch (error) {
                console.error('Error loading practice dates:', error);
            }
            
            await loadDayPractice(currentDayDate, false);
        }

        async function loadDayPractice(dateStr, showShimmer = true) {
            currentDayDate = dateStr;
            updateDayNavUI();
            
            if (showShimmer) {
                showDayShimmer();
            }
            
            try {
                const response = await fetch(`/api/practice_for_date?date=${dateStr}`);
                todayData = await response.json();

                if (todayData.error || !todayData.levels || todayData.levels.length === 0) {
                    document.getElementById('todayContent').innerHTML = `
                        <div class="empty-state">
                            <h3>No Practice</h3>
                            <p>${todayData.error || 'No scheduled practice on this day.'}</p>
                        </div>
                    `;
                    document.getElementById('levelTabs').innerHTML = '';
                    return;
                }

                currentSession = todayData.session;
                
                // Sort levels in proper order
                const sortedLevels = sortLevels(todayData.levels);
                
                const tabsHtml = sortedLevels.map((level, i) => `
                    <button class="level-tab ${i === 0 ? 'active' : ''}" 
                            data-level="${level.level}"
                            onclick="selectTodayLevel('${level.level}')">
                        ${level.level}
                    </button>
                `).join('');
                document.getElementById('levelTabs').innerHTML = tabsHtml;

                if (sortedLevels.length > 0) {
                    currentLevel = sortedLevels[0].level;
                    renderTodayAthletes();
                }
            } catch (error) {
                console.error('Error loading day practice:', error);
                document.getElementById('todayContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function updateDayNavUI(animate = false) {
            const dateContainer = document.getElementById('dayNavDate');
            const dateMain = document.getElementById('dayNavDateMain');
            const dateSub = document.getElementById('dayNavDateSub');
            
            const date = new Date(currentDayDate + 'T00:00:00');
            const dayName = FULL_DAY_NAMES[date.getDay()];
            const monthName = MONTH_NAMES[date.getMonth()];
            const dayNum = date.getDate();
            
            const today = new Date().toISOString().split('T')[0];
            let subText = '';
            if (currentDayDate === today) {
                subText = 'Today';
            } else if (currentDayDate === getDateOffset(today, -1)) {
                subText = 'Yesterday';
            } else if (currentDayDate === getDateOffset(today, 1)) {
                subText = 'Tomorrow';
            }
            
            if (animate) {
                // Fade out
                dateContainer.classList.add('fade-out');
                setTimeout(() => {
                    dateMain.textContent = `${dayName}, ${monthName} ${dayNum}`;
                    dateSub.textContent = subText;
                    // Fade in
                    dateContainer.classList.remove('fade-out');
                }, 100);
            } else {
                dateMain.textContent = `${dayName}, ${monthName} ${dayNum}`;
                dateSub.textContent = subText;
            }
            
            // Update nav buttons
            currentDayIndex = practiceDates.indexOf(currentDayDate);
            document.getElementById('dayPrevBtn').disabled = currentDayIndex <= 0;
            document.getElementById('dayNextBtn').disabled = currentDayIndex >= practiceDates.length - 1;
        }

        function getDateOffset(dateStr, days) {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        }

        function navigateDay(direction) {
            const newIndex = currentDayIndex + direction;
            if (newIndex >= 0 && newIndex < practiceDates.length) {
                currentDayIndex = newIndex;
                currentDayDate = practiceDates[currentDayIndex];
                
                // Update UI immediately with animation
                updateDayNavUI(true);
                
                // Debounce the actual data fetch
                if (dayNavDebounceTimer) {
                    clearTimeout(dayNavDebounceTimer);
                }
                dayNavDebounceTimer = setTimeout(() => {
                    loadDayPractice(currentDayDate, true);
                }, DAY_NAV_DEBOUNCE_MS);
            }
        }

        function selectTodayLevel(level) {
            currentLevel = level;
            document.querySelectorAll('#levelTabs .level-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.level === level);
            });
            renderTodayAthletes();
        }

        function renderTodayAthletes() {
            const levelData = todayData.levels.find(l => l.level === currentLevel);
            if (!levelData) return;

            const noteIcon = `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;

            const html = `
                <div class="athlete-grid">
                    ${levelData.athletes.map(athlete => `
                        <div class="athlete-card status-${athlete.status}" 
                             id="card-${athlete.id}"
                             onclick="cycleStatus(${athlete.id}, '${currentLevel}')">
                            <button class="note-btn ${athlete.notes || athlete.late_minutes ? 'has-note' : ''}" 
                                    onclick="event.stopPropagation(); openNoteModal(${athlete.id}, '${athlete.name.replace(/'/g, "\\'")}', '${currentLevel}', '${todayData.date}', \`${(athlete.notes || '').replace(/`/g, '\\`')}\`, ${athlete.late_minutes || 0}, '${athlete.status}')">
                                ${noteIcon}
                            </button>
                            <div class="athlete-card-name">${athlete.name}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('todayContent').innerHTML = html;
        }

        function cycleStatus(athleteId, level) {
            const levelData = todayData.levels.find(l => l.level === level);
            const athlete = levelData.athletes.find(a => a.id === athleteId);
            
            const currentIndex = STATUS_CYCLE.indexOf(athlete.status);
            const newStatus = STATUS_CYCLE[(currentIndex + 1) % STATUS_CYCLE.length];

            // Optimistic update
            athlete.status = newStatus;
            const card = document.getElementById(`card-${athleteId}`);
            if (card) {
                card.className = `athlete-card status-${newStatus} animating`;
                setTimeout(() => card.classList.remove('animating'), 200);
            }

            // Debounced save
            const key = `${athleteId}-${todayData.date}`;
            debouncedSave(key, {
                athlete_id: athleteId,
                practice_date: todayData.date,
                level: level,
                status: newStatus,
                notes: athlete.notes || null,
                late_minutes: athlete.late_minutes || 0,
                session_id: currentSession.id
            });
        }

        // ============
        // NOTE MODAL
        // ============
        function selectLateTime(minutes) {
            selectedLateTime = minutes;
            document.querySelectorAll('.late-time-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.minutes) === minutes);
            });
        }

        function openNoteModal(athleteId, athleteName, level, practiceDate, currentNote, lateMinutes, status) {
            noteAthleteId = athleteId;
            noteLevel = level;
            notePracticeDate = practiceDate;
            noteStatus = status;
            selectedLateTime = lateMinutes || 0;
            
            document.getElementById('noteAthleteName').textContent = athleteName;
            document.getElementById('noteText').value = currentNote || '';
            
            // Set late time selection
            document.querySelectorAll('.late-time-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.minutes) === selectedLateTime);
            });
            
            document.getElementById('noteModal').classList.add('active');
            document.getElementById('noteText').focus();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            noteAthleteId = null;
            noteLevel = null;
            notePracticeDate = null;
            selectedLateTime = 0;
        }

        async function saveNote() {
            const note = document.getElementById('noteText').value;
            
            // Capture values BEFORE closing modal (which resets them)
            const athleteId = noteAthleteId;
            const level = noteLevel;
            const practiceDate = notePracticeDate;
            const status = noteStatus || 'none';
            const lateMinutes = selectedLateTime;
            const sessionId = currentSession ? currentSession.id : null;
            
            // Update local state if in today view
            let athlete = null;
            if (todayData && todayData.levels) {
                const levelData = todayData.levels.find(l => l.level === level);
                if (levelData) {
                    athlete = levelData.athletes.find(a => a.id === athleteId);
                    if (athlete) {
                        athlete.notes = note;
                        athlete.late_minutes = lateMinutes;
                    }
                }
            }

            closeNoteModal();
            
            if (athlete) {
                renderTodayAthletes();
            }

            try {
                const response = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        athlete_id: athleteId,
                        practice_date: practiceDate,
                        level: level,
                        status: status,
                        notes: note || null,
                        late_minutes: lateMinutes,
                        session_id: sessionId
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed');
                }
            } catch (error) {
                console.error('Error saving note:', error);
                showToast('Failed to save note: ' + error.message);
            }
        }

        document.getElementById('noteModal').addEventListener('click', (e) => {
            if (e.target.id === 'noteModal') closeNoteModal();
        });

        // ============
        // SESSION VIEW
        // ============
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();

                const options = sessions.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

                document.getElementById('sessionSelect').innerHTML = '<option value="">Select session...</option>' + options;
                document.getElementById('copySourceSession').innerHTML = '<option value="">Select source...</option>' + options;
                document.getElementById('copyTargetSession').innerHTML = '<option value="">Select target...</option>' + options;

                const currentResponse = await fetch('/api/sessions/current');
                const current = await currentResponse.json();
                if (current && current.id) {
                    document.getElementById('sessionSelect').value = current.id;
                    document.getElementById('copyTargetSession').value = current.id;
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        let allLevels = [];
        async function loadLevels() {
            try {
                const response = await fetch('/api/levels');
                allLevels = await response.json();

                const options = allLevels.map(l => `<option value="${l}">${l}</option>`).join('');

                document.getElementById('newAthleteLevel').innerHTML = '<option value="">Select...</option>' + options;
            } catch (error) {
                console.error('Error loading levels:', error);
            }
        }

        document.getElementById('sessionSelect').addEventListener('change', loadSessionAttendance);

        async function loadSessionAttendance() {
            const sessionId = document.getElementById('sessionSelect').value;

            if (!sessionId) {
                document.getElementById('sessionLevelTabs').innerHTML = '';
                document.getElementById('sessionContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Select a Session</h3>
                        <p>Choose a session to view attendance</p>
                    </div>
                `;
                return;
            }
            
            // Show shimmer loading
            showSessionShimmer();

            try {
                const response = await fetch(`/api/attendance/session/${sessionId}`);
                sessionData = await response.json();

                if (!sessionData.levels || Object.keys(sessionData.levels).length === 0) {
                    document.getElementById('sessionLevelTabs').innerHTML = '';
                    document.getElementById('sessionContent').innerHTML = `
                        <div class="empty-state">
                            <h3>No Data</h3>
                            <p>No attendance data found</p>
                        </div>
                    `;
                    return;
                }

                // Sort levels in proper order (numeric 1-10, then Xcel)
                const levels = sortLevels(Object.keys(sessionData.levels));
                sessionCurrentLevel = sessionCurrentLevel && levels.includes(sessionCurrentLevel) 
                    ? sessionCurrentLevel 
                    : levels[0];

                const tabsHtml = levels.map(level => `
                    <button class="level-tab ${level === sessionCurrentLevel ? 'active' : ''}" 
                            data-level="${level}"
                            onclick="selectSessionLevel('${level}')">
                        ${level}
                    </button>
                `).join('');
                document.getElementById('sessionLevelTabs').innerHTML = tabsHtml;

                renderSessionGrid();
            } catch (error) {
                console.error('Error loading session attendance:', error);
                document.getElementById('sessionContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function selectSessionLevel(level) {
            sessionCurrentLevel = level;
            document.querySelectorAll('#sessionLevelTabs .level-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.level === level);
            });
            renderSessionGrid();
        }

        function renderSessionGrid() {
            if (!sessionData || !sessionCurrentLevel) return;

            const levelData = sessionData.levels[sessionCurrentLevel];
            if (!levelData || levelData.athletes.length === 0) {
                document.getElementById('sessionContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No Athletes</h3>
                        <p>No athletes for this level</p>
                    </div>
                `;
                return;
            }

            // Filter dates: show if has records OR is in the future
            const allDates = levelData.dates;
            const today = new Date().toISOString().split('T')[0];
            const filteredDates = [];
            const dateIndices = [];
            
            allDates.forEach((d, i) => {
                // Check if any athlete has a record for this date
                const hasRecord = levelData.athletes.some(athlete => {
                    const att = athlete.attendance[i];
                    return att && att.status !== 'none';
                });
                
                // Show date if: has records OR is today or in the future
                if (hasRecord || d >= today) {
                    filteredDates.push(d);
                    dateIndices.push(i);
                }
            });

            if (filteredDates.length === 0) {
                document.getElementById('sessionContent').innerHTML = `
                    <div class="empty-state">
                        <h3>No Records Yet</h3>
                        <p>No attendance records for this level</p>
                    </div>
                `;
                return;
            }

            const dowPctCols = Object.keys(levelData.athletes[0]?.dow_pcts || {});
            const layoutClass = `layout-${sessionLayout}`;

            const html = `
                <div class="attendance-grid-container ${layoutClass}">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th class="name-col">Athlete</th>
                                ${filteredDates.map(d => {
                                    const date = new Date(d + 'T00:00:00');
                                    const dowClass = 'dow-' + DAY_NAMES[date.getDay()].toLowerCase();
                                    return `<th>
                                        <div class="date-header">
                                            <span class="day ${dowClass}">${DAY_NAMES[date.getDay()]}</span>
                                            <span class="date">${date.getMonth()+1}/${date.getDate()}</span>
                                        </div>
                                    </th>`;
                                }).join('')}
                                <th class="pct-col">Total</th>
                                ${dowPctCols.map(d => `<th class="pct-col">${d}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${levelData.athletes.map(athlete => `
                                <tr>
                                    <td class="name-col" title="${athlete.name}">${athlete.name}</td>
                                    ${dateIndices.map(i => {
                                        const att = athlete.attendance[i];
                                        return `
                                        <td>
                                            <div class="attendance-cell status-${att.status}" 
                                                 id="cell-${athlete.id}-${i}"
                                                 data-athlete-id="${athlete.id}"
                                                 data-athlete-name="${athlete.name}"
                                                 data-date="${att.date}"
                                                 data-notes="${(att.notes || '').replace(/"/g, '&quot;')}"
                                                 data-late="${att.late_minutes || 0}"
                                                 data-cell-index="${i}"
                                                 onclick="cycleSessionStatus(${sessionData.session.id}, ${athlete.id}, '${att.date}', '${sessionCurrentLevel}', ${i})"
                                                 onmousedown="startLongPress(this, event)"
                                                 onmouseup="cancelLongPress()"
                                                 onmouseleave="cancelLongPress()"
                                                 ontouchstart="startLongPress(this, event)"
                                                 ontouchend="cancelLongPress()"
                                                 oncontextmenu="return false">
                                            </div>
                                        </td>
                                    `;}).join('')}
                                    <td class="pct-col" style="color: ${getPctColor(athlete.total_pct)}">${athlete.total_pct}%</td>
                                    ${dowPctCols.map(d => `
                                        <td class="pct-col" style="color: ${getPctColor(athlete.dow_pcts[d])}">${athlete.dow_pcts[d] != null ? athlete.dow_pcts[d] + '%' : '-'}</td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('sessionContent').innerHTML = html;
        }

        function getPctColor(pct) {
            if (pct == null) return 'var(--text-muted)';
            
            // Clamp to 0-100
            pct = Math.max(0, Math.min(100, pct));
            
            // Colors: red (absent) -> orange -> yellow -> green (present)
            // Red: #ef4444, Orange: #f97316, Yellow: #eab308, Green: #22c55e
            const red = { r: 239, g: 68, b: 68 };     // 0-50%
            const orange = { r: 249, g: 115, b: 22 }; // ~50%
            const yellow = { r: 234, g: 179, b: 8 };  // ~75%
            const green = { r: 34, g: 197, b: 94 };   // 100%
            
            let r, g, b;
            if (pct <= 50) {
                // Red to Orange (0-50%)
                const t = pct / 50;
                r = Math.round(red.r + (orange.r - red.r) * t);
                g = Math.round(red.g + (orange.g - red.g) * t);
                b = Math.round(red.b + (orange.b - red.b) * t);
            } else if (pct <= 75) {
                // Orange to Yellow (50-75%)
                const t = (pct - 50) / 25;
                r = Math.round(orange.r + (yellow.r - orange.r) * t);
                g = Math.round(orange.g + (yellow.g - orange.g) * t);
                b = Math.round(orange.b + (yellow.b - orange.b) * t);
            } else {
                // Yellow to Green (75-100%)
                const t = (pct - 75) / 25;
                r = Math.round(yellow.r + (green.r - yellow.r) * t);
                g = Math.round(yellow.g + (green.g - yellow.g) * t);
                b = Math.round(yellow.b + (green.b - yellow.b) * t);
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        // Long-press handling for session cells
        let longPressTimer = null;
        let longPressTriggered = false;

        function startLongPress(cell, event) {
            longPressTriggered = false;
            if (event) event.preventDefault(); // Prevent context menu on mobile
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showCellDetails(cell);
            }, 500); // 500ms hold
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function showCellDetails(cell) {
            const athleteName = cell.dataset.athleteName;
            const date = cell.dataset.date;
            const notes = cell.dataset.notes || '';
            const late = parseInt(cell.dataset.late) || 0;
            
            const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });
            
            let content = `<strong>${athleteName}</strong><br>${formattedDate}`;
            if (late > 0) {
                content += `<br><span style="color: var(--status-partial)">Late: ${late} min</span>`;
            }
            if (notes) {
                content += `<br><em style="color: var(--text-secondary)">${notes}</em>`;
            }
            if (!late && !notes) {
                content += `<br><span style="color: var(--text-muted)">No notes</span>`;
            }
            
            // Show a tooltip-style popup
            const popup = document.createElement('div');
            popup.className = 'cell-detail-popup';
            popup.innerHTML = content;
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px 20px;
                z-index: 1000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                text-align: center;
                font-size: 0.9rem;
                line-height: 1.5;
            `;
            
            const overlay = document.createElement('div');
            overlay.className = 'cell-detail-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            `;
            overlay.onclick = () => {
                popup.remove();
                overlay.remove();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (popup.parentNode) popup.remove();
                if (overlay.parentNode) overlay.remove();
            }, 3000);
        }

        function cycleSessionStatus(sessionId, athleteId, date, level, cellIndex) {
            // Don't cycle if long press was triggered
            if (longPressTriggered) {
                longPressTriggered = false;
                return;
            }
            const athlete = sessionData.levels[level].athletes.find(a => a.id === athleteId);
            if (!athlete) return;

            const currentStatus = athlete.attendance[cellIndex].status;
            const currentIdx = STATUS_CYCLE.indexOf(currentStatus);
            const newStatus = STATUS_CYCLE[(currentIdx + 1) % STATUS_CYCLE.length];

            // Optimistic update
            athlete.attendance[cellIndex].status = newStatus;
            const cell = document.getElementById(`cell-${athleteId}-${cellIndex}`);
            if (cell) {
                cell.className = `attendance-cell status-${newStatus} animating`;
                setTimeout(() => cell.classList.remove('animating'), 200);
            }

            // Debounced save
            const key = `${athleteId}-${date}`;
            debouncedSave(key, {
                athlete_id: athleteId,
                practice_date: date,
                level: level,
                status: newStatus,
                session_id: sessionId
            });

            // Update percentages locally (no full refresh)
            updateAthletePercentages(athleteId, level);
        }

        function updateAthletePercentages(athleteId, level) {
            const athlete = sessionData.levels[level].athletes.find(a => a.id === athleteId);
            if (!athlete) return;

            // Calculate new percentages based on current attendance data
            let presentCount = 0;
            let recordedCount = 0;
            const dowCounts = {};
            
            athlete.attendance.forEach((att, i) => {
                if (att.status === 'present' || att.status === 'absent' || att.status === 'partial') {
                    recordedCount++;
                    const d = new Date(att.date + 'T00:00:00');
                    const dow = DAY_NAMES[d.getDay()];
                    if (!dowCounts[dow]) dowCounts[dow] = { present: 0, total: 0 };
                    dowCounts[dow].total++;
                    
                    if (att.status === 'present') {
                        presentCount++;
                        dowCounts[dow].present++;
                    } else if (att.status === 'partial') {
                        presentCount += 0.5;
                        dowCounts[dow].present += 0.5;
                    }
                }
            });

            // Update total percentage
            const totalPct = recordedCount > 0 ? Math.round(presentCount / recordedCount * 100) : 0;
            athlete.total_pct = totalPct;

            // Update dow percentages
            for (const [dow, counts] of Object.entries(dowCounts)) {
                athlete.dow_pcts[dow] = counts.total > 0 ? Math.round(counts.present / counts.total * 100) : null;
            }

            // Update DOM - find the row for this athlete and update percentage cells
            const rows = document.querySelectorAll('.attendance-table tbody tr');
            for (const row of rows) {
                const firstCell = row.querySelector('.attendance-cell');
                if (firstCell && firstCell.dataset.athleteId == athleteId) {
                    // Found the row - update percentage cells
                    const pctCells = row.querySelectorAll('.pct-col');
                    if (pctCells.length > 0) {
                        // First pct cell is total
                        pctCells[0].textContent = `${totalPct}%`;
                        pctCells[0].style.color = getPctColor(totalPct);
                        
                        // Rest are day-of-week
                        const dowPctCols = Object.keys(athlete.dow_pcts);
                        for (let i = 1; i < pctCells.length && i <= dowPctCols.length; i++) {
                            const dow = dowPctCols[i - 1];
                            const pct = athlete.dow_pcts[dow];
                            pctCells[i].textContent = pct != null ? `${pct}%` : '-';
                            pctCells[i].style.color = getPctColor(pct);
                        }
                    }
                    break;
                }
            }
        }

        // ============
        // SETUP VIEW
        // ============
        async function loadSetupData() {
            await loadSessions();
            await loadExistingSessions();
            await loadCurrentSchedules();
            await loadSpecialDates();
            populateSpecialDateDropdowns();
        }

        function populateSpecialDateDropdowns() {
            // Populate session dropdown for special dates
            const sessionSelect = document.getElementById('specialSession');
            const copySource = document.getElementById('copySourceSession');
            if (sessionSelect && copySource) {
                sessionSelect.innerHTML = copySource.innerHTML;
            }
            
            // Populate level dropdown for special dates
            const levelOptions = allLevels.map(l => `<option value="${l}">${l}</option>`).join('');
            const specialLevel = document.getElementById('specialLevel');
            if (specialLevel) {
                specialLevel.innerHTML = '<option value="">Select...</option>' + levelOptions;
            }
        }

        async function loadSpecialDates() {
            try {
                const response = await fetch('/api/special_practice_dates');
                const dates = await response.json();
                
                const container = document.getElementById('specialDatesContainer');
                if (!container) return;
                
                if (!dates || dates.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">No special dates added yet</p>';
                    return;
                }
                
                // Group by session
                const grouped = {};
                dates.forEach(d => {
                    const key = d.session_name || 'Unknown';
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(d);
                });
                
                let html = '';
                for (const [sessionName, specialDates] of Object.entries(grouped)) {
                    html += `<p style="margin: 8px 0 4px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase;">${sessionName}</p>`;
                    html += '<div class="schedule-list">';
                    specialDates.forEach(d => {
                        const date = new Date(d.practice_date + 'T00:00:00');
                        const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                        html += `
                            <div class="schedule-chip">
                                <span>${d.level} ${dateStr} ${d.start_time.slice(0,5)}</span>
                                <button class="remove-btn" onclick="deleteSpecialDate(${d.id})"></button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading special dates:', error);
            }
        }

        async function addSpecialDate() {
            const sessionId = document.getElementById('specialSession').value;
            const date = document.getElementById('specialDate').value;
            const level = document.getElementById('specialLevel').value;
            const startTime = document.getElementById('specialStartTime').value;
            const endTime = document.getElementById('specialEndTime').value;
            
            if (!sessionId || !date || !level || !startTime || !endTime) {
                showToast('Fill all fields');
                return;
            }
            
            try {
                const response = await fetch('/api/special_practice_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: parseInt(sessionId),
                        practice_date: date,
                        level,
                        start_time: startTime,
                        end_time: endTime
                    })
                });
                
                if (response.ok) {
                    document.getElementById('specialDate').value = '';
                    loadSpecialDates();
                    // Refresh practice dates for navigation
                    loadTodaysPractice();
                    showToast('Special date added', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error || 'Failed to add');
                }
            } catch (error) {
                showToast('Failed to add special date');
            }
        }

        async function deleteSpecialDate(id) {
            if (!confirm('Delete this special practice date?')) return;
            
            try {
                await fetch(`/api/special_practice_dates/${id}`, { method: 'DELETE' });
                loadSpecialDates();
                loadTodaysPractice();
                showToast('Deleted', 'success');
            } catch (error) {
                showToast('Failed to delete');
            }
        }

        async function loadExistingSessions() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();

                if (sessions.length === 0) {
                    document.getElementById('existingSessions').innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">No sessions yet</p>';
                    return;
                }

                document.getElementById('existingSessions').innerHTML = `
                    <div class="schedule-list">
                        ${sessions.map(s => `
                            <div class="schedule-chip">
                                <span>${s.name}</span>
                                <button class="remove-btn" onclick="deleteSession(${s.id})"></button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function loadCurrentSchedules() {
            try {
                const [schedulesRes, sessionsRes] = await Promise.all([
                    fetch('/api/practice_schedules'),
                    fetch('/api/sessions')
                ]);
                const schedules = await schedulesRes.json();
                const sessions = await sessionsRes.json();

                if (schedules.length === 0) {
                    document.getElementById('currentSchedules').innerHTML = `
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">No schedules yet. Copy from a previous session or add manually below.</p>
                    `;
                    renderAddScheduleForm(sessions);
                    return;
                }

                // Group by session, keeping session_id for reference
                const grouped = {};
                schedules.forEach(s => {
                    const key = s.session_id || s.session_name;
                    if (!grouped[key]) {
                        grouped[key] = { 
                            name: s.session_name, 
                            id: s.session_id,
                            schedules: [] 
                        };
                    }
                    grouped[key].schedules.push(s);
                });

                const levelOptions = allLevels.map(l => `<option value="${l}">${l}</option>`).join('');
                const dayOptions = DAY_NAMES.map((d, i) => `<option value="${i}">${d}</option>`).join('');

                let html = '';
                for (const [key, group] of Object.entries(grouped)) {
                    html += `
                        <div class="session-group-header">
                            <h4>${group.name}</h4>
                        </div>
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Day</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    group.schedules.forEach(s => {
                        html += `
                            <tr id="sched-row-${s.id}" data-id="${s.id}">
                                <td><span class="sched-level">${s.level}</span></td>
                                <td><span class="sched-day">${DAY_NAMES[s.day_of_week]}</span></td>
                                <td><span class="sched-start">${s.start_time.slice(0,5)}</span></td>
                                <td><span class="sched-end">${s.end_time.slice(0,5)}</span></td>
                                <td class="actions">
                                    <button class="action-btn" onclick="editScheduleRow(${s.id}, '${s.level}', ${s.day_of_week}, '${s.start_time.slice(0,5)}', '${s.end_time.slice(0,5)}')">Edit</button>
                                    <button class="action-btn delete" onclick="deleteSchedule(${s.id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Add new row form for this session
                    html += `
                            <tr class="add-row" id="add-row-${group.id}">
                                <td>
                                    <select id="new-level-${group.id}">
                                        <option value="">Level...</option>
                                        ${levelOptions}
                                    </select>
                                </td>
                                <td>
                                    <select id="new-day-${group.id}">
                                        ${dayOptions}
                                    </select>
                                </td>
                                <td><input type="time" id="new-start-${group.id}" value="17:00"></td>
                                <td><input type="time" id="new-end-${group.id}" value="19:00"></td>
                                <td class="actions">
                                    <button class="action-btn" onclick="addScheduleToSession(${group.id})">+ Add</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    `;
                }

                document.getElementById('currentSchedules').innerHTML = html;
                
                // If there are sessions without schedules, show add form
                const sessionsWithSchedules = new Set(Object.values(grouped).map(g => g.id));
                const sessionsWithoutSchedules = sessions.filter(s => !sessionsWithSchedules.has(s.id));
                if (sessionsWithoutSchedules.length > 0) {
                    renderAddScheduleForm(sessionsWithoutSchedules);
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        function renderAddScheduleForm(sessions) {
            if (!sessions || sessions.length === 0) return;
            
            const levelOptions = allLevels.map(l => `<option value="${l}">${l}</option>`).join('');
            const dayOptions = DAY_NAMES.map((d, i) => `<option value="${i}">${d}</option>`).join('');
            const sessionOptions = sessions.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            const container = document.getElementById('currentSchedules');
            const existingContent = container.innerHTML;
            
            container.innerHTML = existingContent + `
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                    <p style="margin: 0 0 10px; font-size: 0.8rem; color: var(--text-muted);">Add schedule to session:</p>
                    <div class="form-row">
                        <div class="form-group">
                            <select id="scheduleSession">
                                <option value="">Session...</option>
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="scheduleLevel">
                                <option value="">Level...</option>
                                ${levelOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="scheduleDay">${dayOptions}</select>
                        </div>
                        <div class="form-group">
                            <input type="time" id="scheduleStartTime" value="17:00">
                        </div>
                        <div class="form-group">
                            <input type="time" id="scheduleEndTime" value="19:00">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addSchedule()">Add</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createSession() {
            const name = document.getElementById('sessionName').value;
            const year = document.getElementById('sessionYear').value;
            const season = document.getElementById('sessionSeason').value;
            const startDate = document.getElementById('sessionStartDate').value;
            const endDate = document.getElementById('sessionEndDate').value;

            if (!name || !year || !season || !startDate || !endDate) {
                showToast('Fill all fields');
                return;
            }

            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, year, season, start_date: startDate, end_date: endDate })
                });

                if (response.ok) {
                    document.getElementById('sessionName').value = '';
                    document.getElementById('sessionStartDate').value = '';
                    document.getElementById('sessionEndDate').value = '';
                    loadSetupData();
                    showToast('Session created', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error);
                }
            } catch (error) {
                showToast('Failed to create session');
            }
        }

        async function deleteSession(id) {
            if (!confirm('Delete this session?')) return;

            try {
                await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
                loadSetupData();
            } catch (error) {
                showToast('Failed to delete');
            }
        }

        async function addSchedule() {
            const sessionEl = document.getElementById('scheduleSession');
            const levelEl = document.getElementById('scheduleLevel');
            const dayEl = document.getElementById('scheduleDay');
            const startEl = document.getElementById('scheduleStartTime');
            const endEl = document.getElementById('scheduleEndTime');
            
            if (!sessionEl || !levelEl) return;
            
            const sessionId = sessionEl.value;
            const level = levelEl.value;
            const day = dayEl.value;
            const startTime = startEl.value;
            const endTime = endEl.value;

            if (!sessionId || !level || !startTime || !endTime) {
                showToast('Fill all fields');
                return;
            }

            try {
                const response = await fetch('/api/practice_schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: parseInt(sessionId),
                        level,
                        day_of_week: parseInt(day),
                        start_time: startTime,
                        end_time: endTime
                    })
                });

                if (response.ok) {
                    loadCurrentSchedules();
                    showToast('Schedule added', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error);
                }
            } catch (error) {
                showToast('Failed to add schedule');
            }
        }

        async function addScheduleToSession(sessionId) {
            const level = document.getElementById(`new-level-${sessionId}`).value;
            const day = document.getElementById(`new-day-${sessionId}`).value;
            const startTime = document.getElementById(`new-start-${sessionId}`).value;
            const endTime = document.getElementById(`new-end-${sessionId}`).value;

            if (!level) {
                showToast('Select a level');
                return;
            }

            try {
                const response = await fetch('/api/practice_schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        level,
                        day_of_week: parseInt(day),
                        start_time: startTime,
                        end_time: endTime
                    })
                });

                if (response.ok) {
                    loadCurrentSchedules();
                    showToast('Schedule added', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error);
                }
            } catch (error) {
                showToast('Failed to add schedule');
            }
        }

        async function deleteSchedule(id) {
            if (!confirm('Delete this schedule?')) return;

            try {
                await fetch(`/api/practice_schedules/${id}`, { method: 'DELETE' });
                loadCurrentSchedules();
                showToast('Schedule deleted', 'success');
            } catch (error) {
                showToast('Failed to delete');
            }
        }

        function editScheduleRow(id, level, day, start, end) {
            const levelOptions = allLevels.map(l => `<option value="${l}" ${l === level ? 'selected' : ''}>${l}</option>`).join('');
            const dayOptions = DAY_NAMES.map((d, i) => `<option value="${i}" ${i === day ? 'selected' : ''}>${d}</option>`).join('');
            
            const row = document.getElementById(`sched-row-${id}`);
            row.innerHTML = `
                <td>
                    <select id="edit-level-${id}">${levelOptions}</select>
                </td>
                <td>
                    <select id="edit-day-${id}">${dayOptions}</select>
                </td>
                <td><input type="time" id="edit-start-${id}" value="${start}"></td>
                <td><input type="time" id="edit-end-${id}" value="${end}"></td>
                <td class="actions">
                    <button class="action-btn" onclick="saveScheduleEdit(${id})">Save</button>
                    <button class="action-btn" onclick="loadCurrentSchedules()">Cancel</button>
                </td>
            `;
        }

        async function saveScheduleEdit(id) {
            const level = document.getElementById(`edit-level-${id}`).value;
            const day = document.getElementById(`edit-day-${id}`).value;
            const startTime = document.getElementById(`edit-start-${id}`).value;
            const endTime = document.getElementById(`edit-end-${id}`).value;

            try {
                const response = await fetch(`/api/practice_schedules/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level,
                        day_of_week: parseInt(day),
                        start_time: startTime,
                        end_time: endTime
                    })
                });

                if (response.ok) {
                    loadCurrentSchedules();
                    showToast('Schedule updated', 'success');
                } else {
                    const err = await response.json();
                    showToast(err.error);
                }
            } catch (error) {
                showToast('Failed to update schedule');
            }
        }

        async function copySchedules() {
            const sourceId = document.getElementById('copySourceSession').value;
            const targetId = document.getElementById('copyTargetSession').value;

            if (!sourceId || !targetId) {
                showToast('Select both source and target sessions');
                return;
            }

            if (sourceId === targetId) {
                showToast('Source and target must be different');
                return;
            }

            try {
                const response = await fetch('/api/practice_schedules/copy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_session_id: parseInt(sourceId),
                        target_session_id: parseInt(targetId)
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    loadCurrentSchedules();
                    showToast(`Copied ${result.copied} of ${result.total} schedules`, 'success');
                } else {
                    showToast(result.error);
                }
            } catch (error) {
                showToast('Failed to copy schedules');
            }
        }

        async function addAthlete() {
            const name = document.getElementById('newAthleteName').value;
            const level = document.getElementById('newAthleteLevel').value;

            if (!name) {
                showToast('Enter name');
                return;
            }

            try {
                const response = await fetch('/api/athletes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, current_level: level })
                });

                if (response.ok) {
                    document.getElementById('newAthleteName').value = '';
                    showToast('Athlete added', 'success');
                    loadTodaysPractice();
                } else {
                    const err = await response.json();
                    showToast(err.error);
                }
            } catch (error) {
                showToast('Failed to add athlete');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNoteModal();
        });
    </script>
</body>
</html>
